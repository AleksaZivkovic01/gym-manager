<section class="trainer-sessions">
  <div class="page-header">
    <div class="header-content">
      <h1>My training sessions</h1>
      <button
        *ngIf="!showSessionForm"
        type="button"
        class="btn-add-session"
        (click)="toggleSessionForm()"
      >
       Add training session
    </button>
    </div>
  </div>

  <!-- Add/Edit Session Form -->
  <div class="add-session-form-container" *ngIf="showSessionForm">
    <div class="card add-session-card">
      <h2>{{ editingSessionId ? 'Edit training session' : 'Add new training session' }}</h2>

      <form [formGroup]="sessionForm" (ngSubmit)="onSubmitSession()" class="session-form">
        <!-- Success Message -->
        <div class="message success" *ngIf="sessionSuccessMessage">
          {{ sessionSuccessMessage }}
        </div>

        <!-- Error Message -->
        <div class="message error" *ngIf="sessionErrorMessage">
          {{ sessionErrorMessage }}
        </div>

        <!-- Date Field -->
        <div class="form-group">
          <label for="sessionDate">
            Date <span class="required">*</span>
          </label>
          <input
            type="date"
            id="sessionDate"
            formControlName="date"
            [class.invalid]="sessionForm.controls.date.invalid && sessionForm.controls.date.touched"
          />
          <div
            class="error-message"
            *ngIf="sessionForm.controls.date.invalid && sessionForm.controls.date.touched"
          >
            Date is a required field.
          </div>
        </div>

        <!-- Time Field -->
        <div class="form-group">
          <label for="sessionTime">
            Time <span class="required">*</span>
          </label>
          <input
            type="time"
            id="sessionTime"
            formControlName="time"
            [class.invalid]="sessionForm.controls.time.invalid && sessionForm.controls.time.touched"
          />
          <div
            class="error-message"
            *ngIf="sessionForm.controls.time.invalid && sessionForm.controls.time.touched"
          >
            <span *ngIf="sessionForm.controls.time.errors?.['required']">Time is a required field.</span>
            <span *ngIf="sessionForm.controls.time.errors?.['pattern']">Time must be in HH:MM format.</span>
          </div>
        </div>

        <!-- Type Field -->
        <div class="form-group">
          <label for="sessionType">
            Training type <span class="required">*</span>
          </label>
          <input
            type="text"
            id="sessionType"
            formControlName="type"
            placeholder="npr. Kardio, Snaga, Joga..."
            [class.invalid]="sessionForm.controls.type.invalid && sessionForm.controls.type.touched"
          />
          <div
            class="error-message"
            *ngIf="sessionForm.controls.type.invalid && sessionForm.controls.type.touched"
          >
            Training type is a required field.
          </div>
        </div>

        <!-- Max Participants Field -->
        <div class="form-group">
          <label for="sessionMaxParticipants">
            Max participants <span class="required">*</span>
          </label>
          <input
            type="number"
            id="sessionMaxParticipants"
            formControlName="maxParticipants"
            min="1"
            [class.invalid]="sessionForm.controls.maxParticipants.invalid && sessionForm.controls.maxParticipants.touched"
          />
          <div
            class="error-message"
            *ngIf="sessionForm.controls.maxParticipants.invalid && sessionForm.controls.maxParticipants.touched"
          >
            <span *ngIf="sessionForm.controls.maxParticipants.errors?.['required']">Max participants is a required field.</span>
            <span *ngIf="sessionForm.controls.maxParticipants.errors?.['min']">Max participants must be at least 1.</span>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="isSubmittingSession || sessionForm.invalid"
          >
            {{ isSubmittingSession ? 'Creating...' : 'Create Training' }}
          </button>
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="toggleSessionForm()"
            [disabled]="isSubmittingSession"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sessions List -->
  <div class="sessions-container">
    <!-- Filter Section -->
    <div class="filter-section" *ngIf="!loading && allSessions.length > 0">
      <button 
        type="button"
        class="filter-btn"
        [class.active]="selectedFilter === 'upcoming'"
        (click)="setFilter('upcoming')"
      >
        Upcoming
      </button>
      <button 
        type="button"
        class="filter-btn"
        [class.active]="selectedFilter === 'past'"
        (click)="setFilter('past')"
      >
        Past
      </button>
      <button 
        type="button"
        class="filter-btn"
        [class.active]="selectedFilter === 'all'"
        (click)="setFilter('all')"
      >
        All
      </button>
    </div>

    <div class="loading" *ngIf="loading">
      <p>Loading sessions...</p>
    </div>

    <div class="sessions-list" *ngIf="!loading && sessions.length > 0">
      <div class="session-card" *ngFor="let session of sessions">
        <div class="session-header">
          <h3 class="session-type">{{ session.type }}</h3>
          <span class="session-status" [class.upcoming]="isUpcoming(session)" [class.past]="!isUpcoming(session)">
            {{ isUpcoming(session) ? 'Upcoming' : 'Past' }}
          </span>
        </div>
        <div class="session-details">
          <div class="detail-item">
            <span class="detail-label">Date:</span>
            <span class="detail-value">{{ formatDate(session.date) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Time:</span>
            <span class="detail-value">{{ formatTime(session.time) }}h</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Registered:</span>
            <span class="detail-value">
              {{ getRegisteredCount(session) }}/{{ session.maxParticipants }}
              <button 
                *ngIf="getRegisteredCount(session) > 0"
                type="button" 
                class="btn-show-members"
                (click)="toggleMembersList(session)"
                title="Show registered members"
              >
                <!--{{ showMembersForSession[session.id] ? '▼' : '▶' }}-->
                {{ showMembersForSession[session.id] ? 'Hide' : 'Show' }}
              </button>
            </span>
          </div>
        </div>
        
        <!-- Members List -->
        <div class="members-list" *ngIf="showMembersForSession[session.id]">
          <div class="members-loading" *ngIf="loadingMembers[session.id]">
            <p>Loading members...</p>
          </div>
          <div class="members-content" *ngIf="!loadingMembers[session.id]">
            <div class="member-item" *ngFor="let member of sessionMembers[session.id]">
              {{ member.name }}
            </div>
            <div class="no-members" *ngIf="sessionMembers[session.id]?.length === 0">
              <p>No registered members.</p>
            </div>
          </div>
        </div>
        <div class="session-actions">
          <button 
            type="button" 
            class="btn-edit"
            (click)="editSession(session)"
            [disabled]="showSessionForm"
          >
            Edit
          </button>
          <button 
            type="button" 
            class="btn-delete"
            (click)="deleteSession(session)"
            [disabled]="showSessionForm"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <div class="no-sessions" *ngIf="!loading && sessions.length === 0 && allSessions.length === 0">
      <p>You don't have any sessions created.</p>
      <p class="hint">Click "Add Session" to create a new session.</p>
    </div>
    
    <div class="no-sessions" *ngIf="!loading && sessions.length === 0 && allSessions.length > 0">
      <p>No sessions available for the selected filter.</p>
    </div>
  </div>
</section>
